<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Bounty Board - ReldoTheScribe</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:opsz,wght@8..60,400;8..60,600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        :root { 
            --bg: #0d0d0d; 
            --bg-secondary: #151515;
            --bg-tertiary: #1a1a1a;
            --text: #e5e5e5; 
            --text-secondary: #888; 
            --text-tertiary: #555; 
            --border: #222; 
            --link: #66b3ff; 
            --accent: #22c55e;
            --accent-dim: #166534;
            --warning: #f59e0b;
            --error: #ef4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Source Serif 4', Georgia, serif; 
            font-size: 16px; 
            line-height: 1.6; 
            color: var(--text); 
            background: var(--bg); 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 40px 24px; 
        }
        a { color: var(--link); text-decoration: none; }
        a:hover { text-decoration: underline; }
        .back { font-size: 14px; margin-bottom: 24px; font-family: 'Inter', sans-serif; }
        
        header { margin-bottom: 40px; padding-bottom: 24px; border-bottom: 1px solid var(--border); }
        h1 { font-size: 28px; font-weight: 600; line-height: 1.2; margin-bottom: 8px; }
        .subtitle { color: var(--text-secondary); font-size: 15px; margin-bottom: 16px; }
        .contract-info { 
            font-family: 'Inter', sans-serif;
            font-size: 12px; 
            color: var(--text-tertiary);
            background: var(--bg-secondary);
            padding: 12px 16px;
            border-radius: 6px;
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }
        .contract-info span { display: flex; gap: 8px; align-items: center; }
        .contract-info code { 
            background: var(--bg-tertiary); 
            padding: 2px 8px; 
            border-radius: 4px; 
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .wallet-bar {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        .wallet-info { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .wallet-info span { color: var(--text-secondary); font-size: 14px; font-family: 'Inter', sans-serif; }
        .wallet-info strong { color: var(--text); }
        
        button {
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 500;
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
        }
        button:hover { transform: translateY(-1px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .btn-primary { background: var(--accent); color: #000; }
        .btn-primary:hover { background: #4ade80; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-danger { background: var(--error); color: #fff; }
        
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1px;
        }
        .tab {
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            padding: 12px 20px;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            border: none;
            position: relative;
        }
        .tab.active {
            color: var(--text);
            background: var(--bg-secondary);
        }
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
        }
        .tab:hover:not(.active) { color: var(--text); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .bounty-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 24px;
            margin-bottom: 16px;
        }
        .bounty-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .bounty-title { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
        .bounty-id { font-size: 12px; color: var(--text-tertiary); font-family: 'Inter', sans-serif; }
        .bounty-reward {
            font-family: 'Inter', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: var(--accent);
        }
        .bounty-requirements {
            color: var(--text-secondary);
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 16px;
        }
        .bounty-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            color: var(--text-tertiary);
        }
        .bounty-meta span { display: flex; gap: 6px; align-items: center; }
        .status-badge {
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .status-active { background: var(--accent-dim); color: #86efac; }
        .status-claimed { background: #1e3a5f; color: var(--link); }
        .status-resolved { background: #3f3f3f; color: var(--text-secondary); }
        .status-expired { background: #3f1f1f; color: var(--error); }
        
        .submissions-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        .submissions-title {
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }
        .submission-item {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .submission-item:last-child { margin-bottom: 0; }
        .submission-hash {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            color: var(--link);
            margin-bottom: 8px;
            word-break: break-all;
        }
        .submission-meta {
            font-size: 12px;
            color: var(--text-tertiary);
            font-family: 'Inter', sans-serif;
            margin-bottom: 12px;
        }
        .submission-actions { display: flex; gap: 8px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px 16px;
            color: var(--text);
            font-family: 'Source Serif 4', Georgia, serif;
            font-size: 15px;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .form-group small {
            display: block;
            margin-top: 6px;
            font-size: 12px;
            color: var(--text-tertiary);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .stat-value {
            font-family: 'Inter', sans-serif;
            font-size: 28px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 4px;
        }
        .stat-label {
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px 20px;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-color: var(--accent); }
        .toast.error { border-color: var(--error); }
        .toast-title {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .toast-message { font-size: 14px; color: var(--text-secondary); }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        footer {
            margin-top: 64px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
            font-size: 13px;
            color: var(--text-tertiary);
            text-align: center;
        }
        
        @media (max-width: 600px) {
            body { padding: 20px 16px; }
            .bounty-header { flex-direction: column; }
            .wallet-bar { flex-direction: column; align-items: flex-start; }
            .wallet-info { flex-direction: column; gap: 8px; }
        }
    </style>
</head>
<body>
    <p class="back"><a href="/tools.html">‚Üê Back to Tools</a></p>
    
    <header>
        <h1>Research Bounty Board</h1>
        <p class="subtitle">On-chain marketplace for Ethereum research bounties</p>
        <div class="contract-info">
            <span>Network: <strong>Base Mainnet</strong></span>
            <span>Contract: <code id="contract-display">0xb31B...6901</code></span>
            <span>Min Bounty: <strong>0.001 ETH</strong></span>
            <span>Fee: <strong>2.5%</strong></span>
        </div>
    </header>
    
    <div class="wallet-bar">
        <div class="wallet-info">
            <span id="wallet-address">Not connected</span>
            <span id="wallet-balance" style="display:none;">Balance: <strong>‚Äî</strong></span>
        </div>
        <button id="connect-btn" class="btn-primary">Connect Wallet</button>
    </div>
    
    <div class="stats-grid" id="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="stat-total">‚Äî</div>
            <div class="stat-label">Total Bounties</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-active">‚Äî</div>
            <div class="stat-label">Active</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-reward">‚Äî</div>
            <div class="stat-label">Total Rewards</div>
        </div>
    </div>
    
    <div class="tabs">
        <button class="tab active" data-tab="browse">Browse Bounties</button>
        <button class="tab" data-tab="create">Post Bounty</button>
        <button class="tab" data-tab="my-bounties">My Bounties</button>
    </div>
    
    <div id="browse" class="tab-content active">
        <div id="bounties-list">
            <div class="empty-state">
                <div class="loading"></div>
                <p style="margin-top: 16px;">Loading bounties...</p>
            </div>
        </div>
    </div>
    
    <div id="create" class="tab-content">
        <div class="bounty-card">
            <h3 style="margin-bottom: 20px;">Post a New Bounty</h3>
            <form id="create-form">
                <div class="form-group">
                    <label for="topic">Topic / Title</label>
                    <input type="text" id="topic" placeholder="e.g., MEV Builder Latency Analysis" required>
                    <small>Short, descriptive title for your research question</small>
                </div>
                <div class="form-group">
                    <label for="requirements">Requirements</label>
                    <textarea id="requirements" placeholder="Describe the specific data, methodology, and deliverables you expect..." required></textarea>
                    <small>Be specific about what constitutes a valid finding</small>
                </div>
                <div class="form-group">
                    <label for="duration">Duration (days)</label>
                    <input type="number" id="duration" min="1" max="365" value="7" required>
                    <small>Bounty expires after this period if not claimed</small>
                </div>
                <div class="form-group">
                    <label for="reward">Reward (ETH)</label>
                    <input type="number" id="reward" min="0.001" step="0.001" placeholder="0.01" required>
                    <small>Minimum 0.001 ETH. Platform fee: 2.5%</small>
                </div>
                <button type="submit" class="btn-primary" id="create-btn">Post Bounty</button>
            </form>
        </div>
    </div>
    
    <div id="my-bounties" class="tab-content">
        <div id="my-bounties-list">
            <div class="empty-state">
                <p>Connect your wallet to view your bounties and submissions</p>
            </div>
        </div>
    </div>
    
    <div id="toast" class="toast">
        <div class="toast-title" id="toast-title">Success</div>
        <div class="toast-message" id="toast-message">Transaction confirmed</div>
    </div>
    
    <footer>
        <p>Contract verified on <a href="https://basescan.org/address/0xb31BBc175361B32f81c5ecAdF19699Ce757a6901" target="_blank">BaseScan</a></p>
    </footer>

    <script>
        // Contract configuration
        const CONTRACT_ADDRESS = '0xb31BBc175361B32f81c5ecAdF19699Ce757a6901';
        const CONTRACT_ABI = [
            "function postBounty(string calldata topic, string calldata requirements, uint256 duration) external payable returns (uint256 bountyId)",
            "function submitFinding(uint256 bountyId, string calldata findingHash, string calldata evidenceURI) external returns (uint256 submissionId)",
            "function approveSubmission(uint256 bountyId, uint256 submissionId) external",
            "function rejectSubmission(uint256 bountyId, uint256 submissionId) external",
            "function cancelExpiredBounty(uint256 bountyId) external",
            "function getBounty(uint256 bountyId) external view returns (tuple(address sponsor, string topic, string requirements, uint256 reward, uint256 deadline, uint8 status, address claimant, string findingHash, uint256 claimedAt))",
            "function getSubmission(uint256 bountyId, uint256 submissionId) external view returns (address researcher, string findingHash, string evidenceURI, uint256 submittedAt, uint8 status)",
            "function getActiveBounties() external view returns (uint256[] memory)",
            "function bountyCount() external view returns (uint256)",
            "function getSubmissionCount(uint256 bountyId) external view returns (uint256)",
            "function getSponsorBounties(address sponsor) external view returns (uint256[] memory)",
            "function isClaimable(uint256 bountyId) external view returns (bool)",
            "event BountyPosted(uint256 indexed bountyId, address indexed sponsor, string topic, uint256 reward, uint256 deadline)",
            "event SubmissionMade(uint256 indexed bountyId, address indexed researcher, string findingHash, uint256 submissionId)",
            "event BountyResolved(uint256 indexed bountyId, bool approved, address recipient, uint256 payout)"
        ];
        
        let provider, signer, contract, userAddress;
        let bounties = [];
        
        // Status mapping
        const STATUS_MAP = ['Active', 'Claimed', 'Disputed', 'Resolved', 'Expired'];
        const SUBMISSION_STATUS_MAP = ['Pending', 'Approved', 'Rejected'];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            updateContractDisplay();
            setupTabs();
            setupForm();
            
            // Check if already connected
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        await connectWallet();
                    } else {
                        loadBountiesReadOnly();
                    }
                } catch (e) {
                    loadBountiesReadOnly();
                }
            } else {
                loadBountiesReadOnly();
            }
        });
        
        function updateContractDisplay() {
            document.getElementById('contract-display').textContent = 
                CONTRACT_ADDRESS.slice(0, 6) + '...' + CONTRACT_ADDRESS.slice(-4);
        }
        
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                    
                    if (tab.dataset.tab === 'my-bounties' && userAddress) {
                        loadMyBounties();
                    }
                });
            });
        }
        
        function setupForm() {
            document.getElementById('create-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!userAddress) {
                    showToast('Error', 'Please connect your wallet first', 'error');
                    return;
                }
                await postBounty();
            });
        }
        
        document.getElementById('connect-btn').addEventListener('click', connectWallet);
        
        async function connectWallet() {
            if (!window.ethereum) {
                showToast('Error', 'Please install MetaMask or another Web3 wallet', 'error');
                return;
            }
            
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                // Update UI
                document.getElementById('wallet-address').innerHTML = 
                    `Connected: <strong>${userAddress.slice(0, 6)}...${userAddress.slice(-4)}</strong>`;
                document.getElementById('connect-btn').textContent = 'Disconnect';
                document.getElementById('connect-btn').onclick = disconnectWallet;
                document.getElementById('connect-btn').classList.remove('btn-primary');
                document.getElementById('connect-btn').classList.add('btn-secondary');
                
                // Get balance
                const balance = await provider.getBalance(userAddress);
                document.getElementById('wallet-balance').innerHTML = 
                    `Balance: <strong>${parseFloat(ethers.utils.formatEther(balance)).toFixed(4)} ETH</strong>`;
                document.getElementById('wallet-balance').style.display = 'inline';
                
                // Reload bounties with write capabilities
                loadBounties();
                
                showToast('Connected', `Wallet connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`);
                
                // Listen for account changes
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        disconnectWallet();
                    } else {
                        userAddress = accounts[0];
                        document.getElementById('wallet-address').innerHTML = 
                            `Connected: <strong>${userAddress.slice(0, 6)}...${userAddress.slice(-4)}</strong>`;
                        loadBounties();
                    }
                });
                
            } catch (e) {
                showToast('Error', e.message, 'error');
            }
        }
        
        function disconnectWallet() {
            userAddress = null;
            provider = null;
            signer = null;
            contract = null;
            
            document.getElementById('wallet-address').textContent = 'Not connected';
            document.getElementById('wallet-balance').style.display = 'none';
            document.getElementById('connect-btn').textContent = 'Connect Wallet';
            document.getElementById('connect-btn').onclick = connectWallet;
            document.getElementById('connect-btn').classList.add('btn-primary');
            document.getElementById('connect-btn').classList.remove('btn-secondary');
            
            loadBountiesReadOnly();
        }
        
        async function loadBountiesReadOnly() {
            // Use a public provider for read-only access
            provider = new ethers.providers.JsonRpcProvider('https://mainnet.base.org');
            contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
            await loadBounties();
        }
        
        async function loadBounties() {
            try {
                const count = await contract.bountyCount();
                document.getElementById('stat-total').textContent = count.toString();
                
                let totalRewards = ethers.BigNumber.from(0);
                let activeCount = 0;
                const bountiesList = document.getElementById('bounties-list');
                
                if (count.toNumber() === 0) {
                    bountiesList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <p>No bounties posted yet. Be the first!</p>
                        </div>
                    `;
                    updateStats(0, 0, '0');
                    return;
                }
                
                // Load all bounties
                bounties = [];
                let html = '';
                
                for (let i = count.toNumber() - 1; i >= 0; i--) {
                    try {
                        const bounty = await contract.getBounty(i);
                        const isClaimable = await contract.isClaimable(i);
                        const submissionCount = await contract.getSubmissionCount(i);
                        
                        const rewardEth = parseFloat(ethers.utils.formatEther(bounty.reward));
                        totalRewards = totalRewards.add(bounty.reward);
                        if (bounty.status === 0) activeCount++;
                        
                        const deadline = new Date(bounty.deadline.toNumber() * 1000);
                        const isExpired = Date.now() > deadline.getTime();
                        const statusClass = bounty.status === 0 ? (isExpired ? 'status-expired' : 'status-active') : 
                                          bounty.status === 1 ? 'status-claimed' : 'status-resolved';
                        const statusText = bounty.status === 0 ? (isExpired ? 'Expired' : 'Active') : STATUS_MAP[bounty.status];
                        
                        bounties.push({ id: i, ...bounty, isClaimable, submissionCount: submissionCount.toNumber() });
                        
                        html += renderBountyCard(i, bounty, statusClass, statusText, deadline, rewardEth, submissionCount.toNumber());
                    } catch (e) {
                        console.error(`Error loading bounty ${i}:`, e);
                    }
                }
                
                bountiesList.innerHTML = html;
                updateStats(count.toNumber(), activeCount, ethers.utils.formatEther(totalRewards));
                
                // Load submissions for each bounty
                await loadSubmissions();
                
            } catch (e) {
                console.error('Error loading bounties:', e);
                document.getElementById('bounties-list').innerHTML = `
                    <div class="empty-state">
                        <p>Error loading bounties. Please try again.</p>
                    </div>
                `;
            }
        }
        
        function renderBountyCard(id, bounty, statusClass, statusText, deadline, rewardEth, submissionCount) {
            const isSponsor = userAddress && bounty.sponsor.toLowerCase() === userAddress.toLowerCase();
            const canSubmit = userAddress && bounty.status === 0 && Date.now() < deadline.getTime() && !isSponsor;
            
            return `
                <div class="bounty-card" data-bounty-id="${id}">
                    <div class="bounty-header">
                        <div>
                            <div class="bounty-title">${escapeHtml(bounty.topic)}</div>
                            <div class="bounty-id">#${id} ¬∑ Posted by ${bounty.sponsor.slice(0, 6)}...${bounty.sponsor.slice(-4)} ¬∑ ${submissionCount} submission${submissionCount !== 1 ? 's' : ''}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="bounty-reward">${rewardEth.toFixed(4)} ETH</div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    <div class="bounty-requirements">${escapeHtml(bounty.requirements)}</div>
                    <div class="bounty-meta">
                        <span>‚è∞ Deadline: ${deadline.toLocaleDateString()}</span>
                        <span>üí∞ Reward: ${rewardEth.toFixed(4)} ETH</span>
                        ${isSponsor ? '<span>üë§ You are the sponsor</span>' : ''}
                    </div>
                    ${canSubmit ? `
                        <div style="margin-top: 16px;">
                            <button class="btn-secondary" onclick="showSubmitForm(${id})">Submit Finding</button>
                        </div>
                    ` : ''}
                    <div id="submit-form-${id}" style="display:none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                        <h4 style="margin-bottom: 12px; font-size: 14px;">Submit Your Finding</h4>
                        <div class="form-group">
                            <input type="text" id="finding-hash-${id}" placeholder="IPFS hash or gist URL of your findings">
                        </div>
                        <div class="form-group">
                            <input type="text" id="evidence-uri-${id}" placeholder="Link to supporting evidence (optional)">
                        </div>
                        <button class="btn-primary" onclick="submitFinding(${id})">Submit</button>
                        <button class="btn-secondary" onclick="hideSubmitForm(${id})" style="margin-left: 8px;">Cancel</button>
                    </div>
                    <div id="submissions-${id}" class="submissions-section" style="display:none;">
                        <div class="submissions-title">Submissions</div>
                        <div id="submissions-list-${id}"></div>
                    </div>
                </div>
            `;
        }
        
        async function loadSubmissions() {
            for (const bounty of bounties) {
                if (bounty.submissionCount > 0) {
                    await loadBountySubmissions(bounty.id, bounty.submissionCount);
                }
            }
        }
        
        async function loadBountySubmissions(bountyId, count) {
            const container = document.getElementById(`submissions-list-${bountyId}`);
            const section = document.getElementById(`submissions-${bountyId}`);
            if (!container || !section) return;
            
            section.style.display = 'block';
            let html = '';
            
            const bounty = bounties.find(b => b.id === bountyId);
            const isSponsor = userAddress && bounty && bounty.sponsor.toLowerCase() === userAddress.toLowerCase();
            
            for (let i = 0; i < count; i++) {
                try {
                    const sub = await contract.getSubmission(bountyId, i);
                    const statusClass = sub.status === 0 ? 'status-active' : sub.status === 1 ? 'status-resolved' : 'status-expired';
                    const statusText = SUBMISSION_STATUS_MAP[sub.status];
                    const submittedAt = new Date(sub.submittedAt.toNumber() * 1000);
                    
                    html += `
                        <div class="submission-item">
                            <div class="submission-hash">
                                <a href="${sub.findingHash.startsWith('http') ? sub.findingHash : 'https://ipfs.io/ipfs/' + sub.findingHash}" target="_blank">${sub.findingHash}</a>
                            </div>
                            <div class="submission-meta">
                                By ${sub.researcher.slice(0, 6)}...${sub.researcher.slice(-4)} ¬∑ 
                                ${submittedAt.toLocaleDateString()} ¬∑ 
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                            ${sub.evidenceURI ? `<div style="font-size: 13px; margin-bottom: 12px;">Evidence: <a href="${sub.evidenceURI}" target="_blank">${sub.evidenceURI}</a></div>` : ''}
                            ${isSponsor && sub.status === 0 ? `
                                <div class="submission-actions">
                                    <button class="btn-primary" onclick="approveSubmission(${bountyId}, ${i})">Approve</button>
                                    <button class="btn-secondary" onclick="rejectSubmission(${bountyId}, ${i})">Reject</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                } catch (e) {
                    console.error(`Error loading submission ${i} for bounty ${bountyId}:`, e);
                }
            }
            
            container.innerHTML = html || '<p style="color: var(--text-tertiary);">No submissions yet</p>';
        }
        
        function showSubmitForm(bountyId) {
            document.getElementById(`submit-form-${bountyId}`).style.display = 'block';
        }
        
        function hideSubmitForm(bountyId) {
            document.getElementById(`submit-form-${bountyId}`).style.display = 'none';
        }
        
        async function submitFinding(bountyId) {
            const findingHash = document.getElementById(`finding-hash-${bountyId}`).value.trim();
            const evidenceURI = document.getElementById(`evidence-uri-${bountyId}`).value.trim();
            
            if (!findingHash) {
                showToast('Error', 'Please enter a finding hash or URL', 'error');
                return;
            }
            
            try {
                showToast('Pending', 'Submitting your finding...');
                const tx = await contract.submitFinding(bountyId, findingHash, evidenceURI);
                await tx.wait();
                showToast('Success', 'Submission confirmed!');
                hideSubmitForm(bountyId);
                await loadBounties();
            } catch (e) {
                showToast('Error', e.message || 'Transaction failed', 'error');
            }
        }
        
        async function approveSubmission(bountyId, submissionId) {
            try {
                showToast('Pending', 'Approving submission...');
                const tx = await contract.approveSubmission(bountyId, submissionId);
                await tx.wait();
                showToast('Success', 'Submission approved and reward sent!');
                await loadBounties();
            } catch (e) {
                showToast('Error', e.message || 'Transaction failed', 'error');
            }
        }
        
        async function rejectSubmission(bountyId, submissionId) {
            try {
                showToast('Pending', 'Rejecting submission...');
                const tx = await contract.rejectSubmission(bountyId, submissionId);
                await tx.wait();
                showToast('Success', 'Submission rejected');
                await loadBounties();
            } catch (e) {
                showToast('Error', e.message || 'Transaction failed', 'error');
            }
        }
        
        async function postBounty() {
            const topic = document.getElementById('topic').value.trim();
            const requirements = document.getElementById('requirements').value.trim();
            const duration = parseInt(document.getElementById('duration').value);
            const reward = document.getElementById('reward').value;
            
            if (!topic || !requirements || !duration || !reward) {
                showToast('Error', 'Please fill in all fields', 'error');
                return;
            }
            
            try {
                const rewardWei = ethers.utils.parseEther(reward);
                document.getElementById('create-btn').disabled = true;
                document.getElementById('create-btn').textContent = 'Posting...';
                
                showToast('Pending', 'Posting your bounty...');
                const tx = await contract.postBounty(topic, requirements, duration, { value: rewardWei });
                await tx.wait();
                
                showToast('Success', 'Bounty posted successfully!');
                document.getElementById('create-form').reset();
                
                // Switch to browse tab and reload
                document.querySelector('[data-tab="browse"]').click();
                await loadBounties();
                
            } catch (e) {
                showToast('Error', e.message || 'Transaction failed', 'error');
            } finally {
                document.getElementById('create-btn').disabled = false;
                document.getElementById('create-btn').textContent = 'Post Bounty';
            }
        }
        
        async function loadMyBounties() {
            if (!userAddress) return;
            
            const container = document.getElementById('my-bounties-list');
            container.innerHTML = '<div class="loading"></div>';
            
            try {
                const myBountyIds = await contract.getSponsorBounties(userAddress);
                
                if (myBountyIds.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <p>You haven't posted any bounties yet</p>
                            <button class="btn-primary" onclick="document.querySelector('[data-tab=create]').click()" style="margin-top: 16px;">Post Your First Bounty</button>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                for (const id of myBountyIds.reverse()) {
                    const bounty = await contract.getBounty(id);
                    const submissionCount = await contract.getSubmissionCount(id);
                    const deadline = new Date(bounty.deadline.toNumber() * 1000);
                    const rewardEth = parseFloat(ethers.utils.formatEther(bounty.reward));
                    const statusClass = bounty.status === 0 ? 'status-active' : bounty.status === 3 ? 'status-resolved' : 'status-expired';
                    const statusText = STATUS_MAP[bounty.status];
                    
                    html += renderBountyCard(id.toNumber(), bounty, statusClass, statusText, deadline, rewardEth, submissionCount.toNumber());
                }
                
                container.innerHTML = html;
                
                // Load submissions
                for (const id of myBountyIds) {
                    const count = await contract.getSubmissionCount(id);
                    if (count > 0) {
                        await loadBountySubmissions(id.toNumber(), count.toNumber());
                    }
                }
                
            } catch (e) {
                container.innerHTML = `<p style="color: var(--error);">Error loading your bounties</p>`;
            }
        }
        
        function updateStats(total, active, rewards) {
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-reward').textContent = parseFloat(rewards).toFixed(2) + ' ETH';
        }
        
        function showToast(title, message, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toast-title').textContent = title;
            document.getElementById('toast-message').textContent = message;
            toast.className = `toast show ${type}`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
